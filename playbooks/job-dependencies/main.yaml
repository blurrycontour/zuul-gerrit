- name: Init test1 & test2
  include_tasks: init-repo.yaml
  loop:
    - {name: "test1", archive: "hoz-4-demo-repo.tgz"}
    - {name: "test2", archive: "hoz-7-demolib-repo.tgz"}
  loop_control:
    loop_var: repoinfo

- name: Copy zuul.yaml in test1 & test2
  copy:
    src: ../../doc/source/examples/{{item}}-job-dependencies/zuul.yaml
    dest: "{{ workspace }}/{{item}}/.zuul.yaml"
  loop:
    - test1
    - test2

- name: Setup repository test1 & test2
  shell:
    chdir: "{{ workspace }}/{{item}}/"
    executable: /bin/bash
    cmd: |
      {{ ssh_agent.stdout }}
      git add -A
      git commit -m"Initialize CI"
      git review
  loop:
    - test1
    - test2

- name: Check change is merged test1 & test2
  include_tasks: ../setup-tutorial/change-merged.yaml
  loop:
    - test1
    - test2

- name: Copy requirements.txt in test1
  copy:
    src: ../../doc/source/examples/test1-job-dependencies/requirements.txt
    dest: "{{ workspace }}/test1/"
- name: Copy tox.ini in test1
  copy:
    src: ../../doc/source/examples/test1-job-dependencies/tox.ini
    dest: "{{ workspace }}/test1/"
- name: Copy hello.py in test1
  copy:
    src: ../../doc/source/examples/test1-job-dependencies/hello.py
    dest: "{{ workspace }}/test1/hello/"
- name: Add the dependency relationship between test2 and test1
  shell:
    chdir: "{{ workspace }}/test1/"
    executable: /bin/bash
    cmd: |
      {{ ssh_agent.stdout }}
      git add -A
      git commit -m"Import demolib"
      git review
- name: Check test1 change which depends on test2 is merged
  include_tasks: ../setup-tutorial/change-merged.yaml
  vars:
    item: test1

- name: Copy zuul_depend in test1
  copy:
    src: ../../doc/source/examples/test1-job-dependencies/zuul_depend.yaml
    dest: "{{ workspace }}/test1/.zuul.yaml"
- name: Add zuul_depend to test1
  shell:
    chdir: "{{ workspace }}/test1/"
    executable: /bin/bash
    cmd: |
      {{ ssh_agent.stdout }}
      git add -A
      git commit -m"Add dependent job"
      git review
- name: Check test1 zuul_depend is merged
  include_tasks: ../setup-tutorial/change-merged.yaml
  vars:
    item: test1

- name: Copy zuul_depend in test2
  copy:
    src: ../../doc/source/examples/test2-job-dependencies/zuul_depend.yaml
    dest: "{{ workspace }}/test2/.zuul.yaml"
- name: Add zuul_depend to test2
  shell:
    chdir: "{{ workspace }}/test2/"
    executable: /bin/bash
    cmd: |
      {{ ssh_agent.stdout }}
      git add -A
      git commit -m"Add dependent job in test2 CI"
      git review
- name: Check test2 zuul_depend is merged
  include_tasks: ../setup-tutorial/change-merged.yaml
  vars:
    item: test2

- name: Modif test2 uhoh
  shell:
    chdir: "{{ workspace }}/test2/"
    executable: /bin/bash
    cmd: |
      {{ ssh_agent.stdout }}
      git checkout -b uhoh
      sed -i -e "s/Hello Zuul/Hello Dana/" demolib/__init__.py
      sed -i -e "s/Hello Zuul/Hello Dana/" tests/test_demolib.py
      git add -A
      git commit -m"No Zuul, only Dana"
      git review
- name: Check test2 Zull Dana check status is error
  include_tasks: ../setup-tutorial/check-pipeline-error.yaml
  vars:
    item: test2



- name: Modif test2(lib) goodbye
  shell:
    chdir: "{{ workspace }}/test2/"
    executable: /bin/bash
    cmd: |
      {{ ssh_agent.stdout }}
      git checkout master && git pull origin master && git checkout -b goodbye

- name: Copy goodbye demolib/__init__.py in test2(lib)
  copy:
    src: ../../doc/source/examples/test2-job-dependencies/demolib_init.py
    dest: "{{ workspace }}/test2/demolib/__init__.py"
- name: Add zuul_depend to test2
  shell:
    chdir: "{{ workspace }}/test2/"
    executable: /bin/bash
    cmd: |
      {{ ssh_agent.stdout }}
      git add -A
      git commit -m"Bye Zuul"
      git review
- name: Check Zuul check status test2(lib) is ok
  include_tasks: ../setup-tutorial/check-pipeline-ok.yaml
  vars:
    item: test2
- set_fact:
    test2_bye_check_result: "{{ changeinfo }}"

- name: Modif test1(app) goodbye
  shell:
    chdir: "{{ workspace }}/test1/"
    executable: /bin/bash
    cmd: |
      {{ ssh_agent.stdout }}
      git checkout master && git pull origin master && git checkout -b goodbye

- name: Copy goodbye hello/hello.py in test1(app)
  copy:
    src: ../../doc/source/examples/test1-job-dependencies/goodbye_hello.py
    dest: "{{ workspace }}/test1/hello/hello.py"
- name: Add zuul_depend to test1
  shell:
    chdir: "{{ workspace }}/test1/"
    executable: /bin/bash
    cmd: |
      {{ ssh_agent.stdout }}
      git add -A
      git commit -m"Bye Zuul"
      git review
- name: Check Zuul check status test1(app) is error
  include_tasks: ../setup-tutorial/check-pipeline-error.yaml
  vars:
    item: test1
- set_fact:
    test1_bye_check_result: "{{ changeinfo }}"

- name: Add Depends-On
  shell:
    chdir: "{{ workspace }}/test1/"
    executable: /bin/bash
    cmd: |
      {{ ssh_agent.stdout }}
      git commit --amend -m"Bye Zuul

      Depends-On: http://gerrit:8080/{{test2_bye_check_result.number}}
      Change-Id: {{test1_bye_check_result.change_id}}"
      git review

- name: Check Zuul check status test1 is ok
  include_tasks: ../setup-tutorial/check-pipeline-ok.yaml
  vars:
    item: test1
