---
- name: Init Test1
  include_role:
    name: init-repository
  vars:
    projectname: test1

- name: Copy use-zuul-jobs.tgz in test1
  copy:
    src: ../../doc/source/tutorials/archive/use-zuul-jobs.tgz
    dest: "{{ workspace }}/"

- name: Commit and upload resources in test1
  shell:
    chdir: "{{ workspace }}/test1/"
    executable: /bin/bash
    cmd: |
      {{ ssh_agent.stdout }}
      tar xzf ../use-zuul-jobs.tgz -C .
      git add -A .

- name: Copy .zuul.yaml in test1
  copy:
    src: ../../doc/source/examples/test1-use-zuul-jobs/zuul.yaml
    dest: "{{ workspace }}/test1/.zuul.yaml"

- name: Commit and upload pipelines in test1
  shell:
    chdir: "{{ workspace }}/test1/"
    executable: /bin/bash
    cmd: |
      {{ ssh_agent.stdout }}
      git add .zuul.yaml
      git commit -m"Init test1 pipelines"
      git review

- include_role:
    name: check-pipeline
  vars:
    title: "Init test1 pipeline"
    projectname: test1
    check_timeout: 250

- name: Shutdown docker-compose
  command: >
    docker container stop
      zuul_tutorial_executor_1
      zuul_tutorial_scheduler_1
      zuul_tutorial_web_1
      zuul_tutorial_mysql_1
      zuul_tutorial_launcher_1
      zuul_tutorial_zk_1

- name: Set nodepool dest directory
  set_fact:
    docker_config_dest_base_dir: "{{ zuul.project.src_dir if not local else '../..' }}"

- name: Copy nodepool multi nodes
  copy:
    src: "../../doc/source/examples/docker-config-1/etc_nodepool/nodepool-nodes.yaml"
    dest: "{{ docker_config_dest_base_dir }}/doc/source/examples/docker-config-1/etc_nodepool/nodepool.yaml"

- name: Run docker-compose up
  shell:
    cmd: "pwd; docker-compose -f docker-compose-nodes.yaml -p zuul_tutorial up -d"
    chdir: "{{ docker_config_dest_base_dir }}/doc/source/examples/docker-config-1"

- name: Wait 30
  pause:
    seconds: 30

- include_role:
    name: remove-verified
  vars:
    change_id: "{{ changeinfo.id }}"

- name: Start recheck
  include_role:
    name: recheck-change
  vars:
    change_id: "{{ changeinfo.id }}"

- include_role:
    name: check-pipeline
  vars:
    title: "Init test1 pipeline"
    projectname: test1
    check_timeout: 250
    check_number: 2
