---
# Use a block to add become to a set of tasks
- block:
  # Add the authorization first, to take advantage of manage_dir
  - name: Authorize build key
    authorized_key:
      user: "{{ copy_sshkey_target_user }}"
      manage_dir: yes
      key: "ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAvKYcWK1T7e3PKSFiqb03EYktnoxVASpPoq2rJw2JvhsP0JfS+lKrPzpUQv7L4JCuQMsPNtZ8LnwVEft39k58Kh8XMebSfaqPYAZS5zCNvQUQIhP9myOevBZf4CDeG+gmssqRFcWEwIllfDuIzKBQGVbomR+Y5QuW0HczIbkoOYI6iyf2jB6xg+bmzR2HViofNrSa62CYmHS6dO04Z95J27w6jGWpEOTBjEQvnb9sdBc4EzaBVmxCpa2EilB1u0th7/DvuH0yP4T+X8G8UjW1gZCTOVw06fqlBCST4KjdWw1F/AuOCT7048klbf4H+mCTaEcPzzu3Fkv8ckMWtS/Z9Q== jeblair@operational-necessity"

  - name: Get the {{ copy_sshkey_target_user }} user home folder
    user:
      name: "{{ copy_sshkey_target_user }}"
    register: target_user_registered

  # The copy module does not work with become_user even if pipelining is
  # enabled when both ansible user and become_user are not root:
  # http://docs.ansible.com/ansible/latest/user_guide/become.html#becoming-an-unprivileged-user
  - name: Install the build private key
    copy:
      content: "foo"
      dest: "{{ target_user_registered.home }}/.ssh/id_rsa"
      mode: 0600
      owner: "{{ copy_sshkey_target_user }}"
      force: no

  - name: Install the build public key
    copy:
      content: "foo"
      dest: "{{ target_user_registered.home }}/.ssh/id_rsa.pub"
      mode: 0644
      owner: "{{ copy_sshkey_target_user }}"
      force: no
  become: true
