<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
      <style type="text/css">

        body {
          font-family: monospace;
          background-color: black;
          color: lightgrey;
        }

        #overlay {
            position: fixed;
            top: 5px;
            right: 5px;
            background-color: darkgrey;
            color: black;
        }

        pre {
            white-space: pre;
            margin: 0px 10px;
        }
      </style>

    <script type="text/javascript">

      window.onload = function() {

        pageUpdateInMS = 250;
        var receiveBuffer = "";

        setInterval(function() {
          console.log("autoScroll");
          if (receiveBuffer != "") {
            document.getElementById('pagecontent').innerHTML += receiveBuffer;
            receiveBuffer = "";
            if (document.getElementById('autoscroll').checked) {
              window.scrollTo(0, document.body.scrollHeight);
            }
          }
        }, pageUpdateInMS);

        var url = new URL(window.location);
        var params = {
            uuid: url.searchParams.get('uuid')
        }
        document.getElementById('pagetitle').innerHTML = params['uuid'];
        if (url.searchParams.has('logfile')) {
            params['logfile'] = url.searchParams.get('logfile');
            document.getElementById('pagetitle').innerHTML += "(" + params['logfile'] + ")";
        }

        // { zuul_web_root }/static/stream.html -> { zuul_web_root }/console-stream
        // TODO Passing in the actual web root is important here, but needs a
        // a smidge more plumbing.
        var ws = new WebSocket('../console-stream');

        ws.onmessage = function(event) {
          console.log("onmessage");
          receiveBuffer = receiveBuffer + event.data + "\n";
        };

        ws.onopen = function(event) {
          console.log("onopen");
          ws.send(JSON.stringify({
              uuid: params['uuid'],
              logfile: params['logfile'],
          }));
        };

        ws.onclose = function(event) {
          console.log("onclose");
          receiveBuffer = receiveBuffer + "\n--- END OF STREAM ---\n";
        };

      };

    </script>

    <title id="pagetitle"></title>
  </head>

  <body>

    <div id="overlay">
      <form>
        <input type="checkbox" id="autoscroll" checked> autoscroll
      </form>
    </div>

    <pre id="pagecontent"></pre>

  </body>
</html>
