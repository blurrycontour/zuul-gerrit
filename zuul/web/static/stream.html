<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
      <style type="text/css">

        body {
          font-family: monospace;
          background-color: black;
          color: lightgrey;
        }

        #overlay {
            position: fixed;
            top: 5px;
            right: 5px;
            background-color: darkgrey;
            color: black;
        }

        pre {
            white-space: pre;
            margin: 0px 10px;
        }
      </style>

    <script type="text/javascript">

      window.onload = function() {

        pageUpdateInMS = 250;
        var receiveBuffer = "";

        setInterval(function() {
          console.log("autoScroll");
          if (receiveBuffer != "") {
            document.getElementById('pagecontent').innerHTML += receiveBuffer;
            receiveBuffer = "";
            if (document.getElementById('autoscroll').checked) {
              window.scrollTo(0, document.body.scrollHeight);
            }
          }
        }, pageUpdateInMS);

        var url = new URL(window.location);
        var websocket_url = null;
        // Allow for local testing / url overriding websocket location
        // This may not be necessary - just adding a file named ../info
        // worked fine for me when I was testing locally.
        if (url.searchParams.has('websocket_url')) {
            websocket_url = url.searchParams.get('websocket_url');
        } else {
            // static/stream.html expects to find a json document with
            // websocket_url in ../info.
            var info = fetch('../info')
                .then(function(response) {
                    return response.json();
                });
            websocket_url = url.searchParams.get('websocket_url');
        }

        var params = {
            uuid: url.searchParams.get('uuid')
        }
        document.getElementById('pagetitle').innerHTML = params['uuid'];
        if (url.searchParams.has('logfile')) {
            params['logfile'] = url.searchParams.get('logfile');
            document.getElementById('pagetitle').innerHTML += "(" + params['logfile'] + ")";
        }

        var ws = new WebSocket(websocket_url);

        ws.onmessage = function(event) {
          console.log("onmessage");
          receiveBuffer = receiveBuffer + event.data + "\n";
        };

        ws.onopen = function(event) {
          console.log("onopen");
          ws.send(JSON.stringify(params));
        };

        ws.onclose = function(event) {
          console.log("onclose");
          receiveBuffer = receiveBuffer + "\n--- END OF STREAM ---\n";
        };

        };

    </script>

    <title id="pagetitle"></title>
  </head>

  <body>

    <div id="overlay">
      <form>
        <input type="checkbox" id="autoscroll" checked> autoscroll
      </form>
    </div>

    <pre id="pagecontent"></pre>

  </body>
</html>
