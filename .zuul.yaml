- nodeset:
    name: zuul-functional
    nodes:
      - name: controller
        label: ubuntu-xenial
      - name: node1
        label: ubuntu-xenial
      - name: node2
        label: ubuntu-xenial
    groups:
      - name: node
        nodes:
          - node1
          - node2

- job:
    name: zuul-stream-functional
    parent: multinode
    nodeset: zuul-functional
    pre-run: playbooks/zuul-stream/pre
    run: playbooks/zuul-stream/functional
    post-run:
      - playbooks/zuul-stream/post
      - playbooks/zuul-stream/post-ara
    required-projects:
      - openstack/ara
    files:
      - "zuul/ansible/callback/.*"
      - "playbooks/zuul-stream/.*"

- job:
    name: zuul-migrate
    parent: unittests
    run: playbooks/zuul-migrate/run
    post-run: playbooks/zuul-migrate/post
    # We're adding zuul to the required-projects so that we can also trigger
    # this from project-config changes
    required-projects:
      - openstack-infra/openstack-zuul-jobs
      - openstack-infra/project-config
      - name: openstack-infra/zuul
        override-branch: feature/zuulv3

- job:
    name: zuul-npm-build
    parent: unittests
    success-url: 'web/status.html?source_url=http://zuulv3.openstack.org/status.json'
    run: playbooks/run-javascript
    post-run: playbooks/collect-javascript

- project:
    name: openstack-infra/zuul
    infra-check:
      jobs:
        - build-openstack-infra-sphinx-docs:
            success-url: 'html/feature/zuulv3/'
            irrelevant-files:
              - zuul/cmd/migrate.py
              - playbooks/zuul-migrate/.*
        - tox-cover:
            irrelevant-files:
              - zuul/cmd/migrate.py
              - playbooks/zuul-migrate/.*
            voting: false
        - tox-pep8
        - tox-py35:
            irrelevant-files:
              - zuul/cmd/migrate.py
              - playbooks/zuul-migrate/.*
        - zuul-npm-build
        - zuul-stream-functional
        - zuul-migrate:
            files:
              - zuul/cmd/migrate.py
              - playbooks/zuul-migrate/.*
    infra-gate:
      jobs:
        - build-openstack-infra-sphinx-docs:
            success-url: 'html/feature/zuulv3/'
        - tox-pep8
        - tox-py35:
            irrelevant-files:
              - zuul/cmd/migrate.py
              - playbooks/zuul-migrate/.*
        - zuul-npm-build
        - zuul-stream-functional
    infra-post:
      jobs:
        - publish-openstack-sphinx-docs-infra
        - publish-openstack-python-branch-tarball
        - tox-py35
        - tox-tarball
