- nodeset:
    name: zuul-functional-temp-master
    nodes:
      - name: controller
        label: ubuntu-xenial
      - name: node1
        label: ubuntu-xenial
      - name: node2
        label: ubuntu-xenial
    groups:
      - name: node
        nodes:
          - node1
          - node2

- job:
    name: zuul-stream-functional
    parent: multinode
    nodeset: zuul-functional-temp-master
    pre-run: playbooks/zuul-stream/pre.yaml
    run: playbooks/zuul-stream/functional.yaml
    post-run:
      - playbooks/zuul-stream/post.yaml
      - playbooks/zuul-stream/post-ara.yaml
    required-projects:
      - openstack/ara
    files:
      - zuul/ansible/.*
      - playbooks/zuul-stream/.*
      - requirements.txt

- job:
    name: zuul-tox-remote
    parent: tox
    vars:
      tox_envlist: remote
      tox_environment:
        ZUUL_SSH_KEY: /home/zuul/.ssh/id_rsa
        ZUUL_REMOTE_IPV4: "{{ nodepool.interface_ip }}"
        ZUUL_REMOTE_KEEP: "true"

- job:
    name: zuul-build-dashboard
    parent: build-javascript-content
    success-url: 'npm/html/status.html'
    files:
      - package.json
      - tsconfig.json
      - tslint.json
      - web/.*
      - webpack.config.js
      - yarn.lock
    vars:
      javascript_content_dir: zuul/web/static
      zuul_api_url: https://zuul.openstack.org
    run: playbooks/dashboard/run.yaml

- job:
    name: zuul-build-dashboard-multi-tenant
    parent: zuul-build-dashboard
    success-url: 'npm/html/tenants.html'
    post-run: playbooks/dashboard/multi.yaml
    vars:
      zuul_api_url: https://softwarefactory-project.io/zuul
      javascript_copy_links: false

- secret:
    name: zuul_docker_login
    data:
      user: !encrypted/pkcs1-oaep
        - Cd8fTdE707eRwVIeXFVK+dPTrAnJJMeOnt2WuB5kihjmii6IQYaa1MnRkXs60AR6e8xUP
          s9080rWI/uw39QFqjHGnjIx9BfjR8Vd5JsOqV99+Wts3ToUFxs2z7EdnZclg4bFA695do
          P2H+ArrcWl5haUFzP1Kx6PGW58ww1l9z4bmDxOwHpwS8UFfhmsIV6WGMvb3anuK2t7l6k
          wNb7jqIHYoW5ppv7M6hWIwbdsld/EjHPswSL64P4KRNyKV18lkgmOT8BS3+pNzWHNSrHF
          RPkvIUEtla6BEqrro8Q2Qj8S0lqxCmZ7H123FWUmesxiy7E8026lFMnGX9VhKB/FoBvvg
          WY6CWGqrZRTma5qUr7w43cBxquhL4WIWKLKTygsLVVjHNi1nH18AnztHqRMm4WIm863yx
          KS4g8QQhUwur6TkuK/Irf11eAybWTPVqbd58fKE/4oPa7B6q4hcv/cysvr2n79KBbfUb7
          gk3t2Gf8V42G6CO/AzhcAWN2KQmno2jU6FAK1h8sUx5DFkoUgoNpxpKPjRMT6rhl8GNX4
          u5is2mnn+HIeRHMy4NWp8Q+csZCFy61/d8sBPqlsLiW27X9SrKv+6Ev3CDRyLB9qqikF0
          sLjtBnSvxMfVnU+hPkwkbP1cdGdEpJPN5oj4xnPWj3ROt5WMum3M4N00pp6xuE=
      password: !encrypted/pkcs1-oaep
        - PIeZMve6M3WwXf9qYh/90AVEfRJ8+5dSskN0vnor+KekK/Dbw5nmm1ES7ilSNOA5tb6Gb
          R2iOORcejGw8ZkFldhjO5Mco04q/WFaKmfJsxead2qnrHsNRmlGkg9V8x/C7p1DFcp6WP
          KpLRMRpPkqsKyatqxtpr2upti54YhQ8vu8xTA6GHXyqn5L4fhJiGA54wFWHTg8roKDkj+
          g5Iab6JbV4yq7EFuzn4QQqaMvpRHD6bKJab6D/QbS0LTThh0rvmw8j+U01gzCkLiRbj0Y
          MB2l6PArjTuVzsEpCMgKvmylcKZ/ISRm3pPY86e4UtO3JREoU5gWBizEA3icTC/iTu2Ca
          ghUUbRW/xlLOzStoJCOSlOGk5NgJ08mmp+hd+DV9fkxN1Uhk1S/lebR5z7Owo/dop39wO
          oJvDzjuycW8vvahlgwFVNO6Zf+mc1FXPeq9vBO3WaXksAbK0jeOS1WAV1Pa4IhxgXrWFO
          PdXxIXg76NCbM7RGj+fRzsh4ERPdDHjI3nY5gapJGyud7fdIlMJjTR6jjlmkSszsuWTGE
          R3Amj/0VyBydvFVWwUwgAoU0n5GgGq4mqyj6H52kNtsis9aWyMDaTd0PTSThfyh+roOYn
          0D8lmXchxSe+YbmqZ59ISXSa0Z/oADYGGBDYvApmZo3KdE5wuPBLqs5SHmCFuA=

- job:
    name: zuul-push-container-images
    parent: pbrx-push-container-images
    pre-run: playbooks/zuul-containers/pre.yaml
    secrets:
      - zuul_docker_login

- project:
    check:
      jobs:
        - build-sphinx-docs:
            irrelevant-files:
              - zuul/cmd/migrate.py
              - playbooks/zuul-migrate/.*
            vars:
              sphinx_python: python3
        - tox-pep8
        - tox-py35:
            irrelevant-files:
              - zuul/cmd/migrate.py
              - playbooks/zuul-migrate/.*
        - tox-py36:
            nodeset: ubuntu-bionic
            irrelevant-files:
              - zuul/cmd/migrate.py
              - playbooks/zuul-migrate/.*
        - zuul-build-dashboard
        - zuul-build-dashboard-multi-tenant
        - nodejs-npm-run-lint:
            vars:
                node_version: 8
            success-url: 'npm/reports/bundle.html'
            files:
              - package.json
              - tsconfig.json
              - tslint.json
              - web/.*
              - webpack.config.js
              - yarn.lock
        - zuul-stream-functional
        - zuul-tox-remote
        - pbrx-build-container-images:
            vars:
              pbrx_prefix: zuul
        - nodepool-zuul-functional:
            voting: false
    gate:
      jobs:
        - build-sphinx-docs:
            irrelevant-files:
              - zuul/cmd/migrate.py
              - playbooks/zuul-migrate/.*
            vars:
              sphinx_python: python3
        - tox-pep8
        - tox-py35:
            irrelevant-files:
              - zuul/cmd/migrate.py
              - playbooks/zuul-migrate/.*
        - tox-py36:
            nodeset: ubuntu-bionic
            irrelevant-files:
              - zuul/cmd/migrate.py
              - playbooks/zuul-migrate/.*
        - zuul-build-dashboard
        - nodejs-npm-run-lint:
            vars:
                node_version: 8
            success-url: 'npm/reports/bundle.html'
            files:
              - package.json
              - tsconfig.json
              - tslint.json
              - web/.*
              - webpack.config.js
              - yarn.lock
        - zuul-stream-functional
        - zuul-tox-remote
        - pbrx-build-container-images:
            vars:
              pbrx_prefix: zuul
    post:
      jobs:
        - publish-zuul-docs
        - publish-openstack-python-branch-tarball
        - publish-openstack-javascript-content:
            vars:
                node_version: 8
        - zuul-push-container-images:
            vars:
              pbrx_prefix: zuul

    release:
      jobs:
        - publish-zuul-docs
