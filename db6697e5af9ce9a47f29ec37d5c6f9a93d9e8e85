{
  "comments": [
    {
      "key": {
        "uuid": "44c79b27_9aacf60c",
        "filename": "zuul/scheduler.py",
        "patchSetId": 17
      },
      "lineNbr": 118,
      "author": {
        "id": 4146
      },
      "writtenOn": "2021-06-30T20:03:59Z",
      "side": 1,
      "message": "You might consider adding a small amount of jitter to these intervals to reduce contention.\n\nhttps://apscheduler.readthedocs.io/en/stable/modules/triggers/interval.html#module-apscheduler.triggers.interval",
      "revId": "db6697e5af9ce9a47f29ec37d5c6f9a93d9e8e85",
      "serverId": "4a232e18-c5a9-48ee-94c0-e04e7cca6543",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ede82eaf_bf507489",
        "filename": "zuul/scheduler.py",
        "patchSetId": 17
      },
      "lineNbr": 118,
      "author": {
        "id": 1
      },
      "writtenOn": "2021-06-30T20:14:19Z",
      "side": 1,
      "message": "Good idea.",
      "revId": "db6697e5af9ce9a47f29ec37d5c6f9a93d9e8e85",
      "serverId": "4a232e18-c5a9-48ee-94c0-e04e7cca6543",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f69ce0a1_786a8181",
        "filename": "zuul/scheduler.py",
        "patchSetId": 17
      },
      "lineNbr": 430,
      "author": {
        "id": 4146
      },
      "writtenOn": "2021-06-30T20:03:59Z",
      "side": 1,
      "message": "I\u0027m not sure this loop makes as much sense here anymore now that apsched is scheduling this stuff. Maybe make it an if statement then put the add_job()s below in a finally case for the exceptions? Just thinking if we fail on the first pass we don\u0027t need to try again in a tight loop we can wait an interval and try then?",
      "revId": "db6697e5af9ce9a47f29ec37d5c6f9a93d9e8e85",
      "serverId": "4a232e18-c5a9-48ee-94c0-e04e7cca6543",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "43f74af5_5f0e54f2",
        "filename": "zuul/scheduler.py",
        "patchSetId": 17
      },
      "lineNbr": 430,
      "author": {
        "id": 1
      },
      "writtenOn": "2021-06-30T20:14:19Z",
      "side": 1,
      "message": "I don\u0027t think I follow the suggestion.  My understanding of this method is that it\u0027s imperative to run the semaphore cleanup immediately after starting the scheduler.  We can\u0027t wait an hour for it to start, because if the scheduler crashed, semaphores will be held and those jobs won\u0027t run until the cleanup happens.\n\nSo we must have a tight loop to wait until the initial reconfiguration is complete and then immediately run the semaphore cleanup.  Once that\u0027s done, we can be certain that we\u0027re not in that state and can schedule the hourly job (which should probably never actually clean anything up).",
      "revId": "db6697e5af9ce9a47f29ec37d5c6f9a93d9e8e85",
      "serverId": "4a232e18-c5a9-48ee-94c0-e04e7cca6543",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "48439a33_e8045fce",
        "filename": "zuul/scheduler.py",
        "patchSetId": 17
      },
      "lineNbr": 430,
      "author": {
        "id": 4146
      },
      "writtenOn": "2021-06-30T20:23:14Z",
      "side": 1,
      "message": "I think in my head the type of situation that might cause the issue I foresee is not being able to talk to zookeeper or having a flaky connection. In that case its better to just wait. That said I agree that waiting longer than necessary to clean up semaphores would be a problem.\n\nIs there any concern that we will schedule the cleanups to happen in an hour then still be running through this loop an hour later (and then have contention with ourselves? We hold the proper locks so that shouldn\u0027t be a functional problem.\n\nIf we are ok with the possibility of overlap in exceptional cases then this is probably fine as is.",
      "parentUuid": "43f74af5_5f0e54f2",
      "revId": "db6697e5af9ce9a47f29ec37d5c6f9a93d9e8e85",
      "serverId": "4a232e18-c5a9-48ee-94c0-e04e7cca6543",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "66261bda_7a8bca8b",
        "filename": "zuul/scheduler.py",
        "patchSetId": 17
      },
      "lineNbr": 430,
      "author": {
        "id": 1
      },
      "writtenOn": "2021-06-30T20:30:01Z",
      "side": 1,
      "message": "We won\u0027t schedule the jobs until we get through at least the semaphore and build request cleanup, so I don\u0027t think it\u0027s possible to overlap.\n\nI could see moving everything below line 433 out of the loop, as once we\u0027ve reconfigured, the cleanups should work and then the job scheduled.  But if something goes wrong during the semaphore cleanup, we should probably retry it sooner than 1 hour, so I\u0027d at least like to keep that inside the loop.  The build request cleanup is on a short enough schedule that I\u0027m ambivalent about that one.",
      "revId": "db6697e5af9ce9a47f29ec37d5c6f9a93d9e8e85",
      "serverId": "4a232e18-c5a9-48ee-94c0-e04e7cca6543",
      "unresolved": false
    }
  ]
}